<!DOCTYPE html>
<html lang="pt-PT" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registo de Presen√ßas</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="Aplica√ß√£o para registo simplificado de presen√ßas escolares">
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    
    <style>
        :root {
            /* Light Mode Color Tokens */
            --color-background: #FCFCF9;
            --color-surface: #FFFFFF;
            --color-text: #13343B;
            --color-text-secondary: #626C71;
            --color-primary: #21808D;
            --color-primary-hover: #1D727E;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-btn-primary-text: #FFFFFF;
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-warning: #A84B2F;
            --color-danger: #B91C1C;
            --color-focus-ring: rgba(33, 128, 141, 0.4);
        }

        [data-color-scheme="dark"] {
            /* Dark Mode Color Tokens */
            --color-background: #1F2121;
            --color-surface: #262828;
            --color-text: #F5F5F5;
            --color-text-secondary: rgba(167, 169, 169, 0.7);
            --color-primary: #32B8C6;
            --color-primary-hover: #2DA2AF;
            --color-border: rgba(119, 124, 124, 0.3);
            --color-btn-primary-text: #13343B;
            --color-secondary: rgba(119, 124, 124, 0.15);
            --color-warning: #E68161;
            --color-danger: #F87171;
            --color-focus-ring: rgba(50, 184, 198, 0.4);
        }

        :root {
            /* Shared Design Tokens */
            --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-sm: 12px; --font-size-base: 14px; --font-size-lg: 16px;
            --font-size-xl: 18px; --font-size-2xl: 20px; --font-size-3xl: 24px;
            --space-4: 4px; --space-8: 8px; --space-12: 12px; --space-16: 16px;
            --space-20: 20px; --space-24: 24px; --space-32: 32px;
            --radius-base: 8px; --radius-lg: 12px; --radius-full: 9999px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
            --container-lg: 1024px;
        }

        html { font-family: var(--font-family-base); color: var(--color-text); background-color: var(--color-background); -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { margin: 0; padding: 0; }
        *, *::before, *::after { box-sizing: inherit; }
        h1, h2, h3, h4 { margin: 0; font-weight: 600; }
        h1 { font-size: var(--font-size-3xl); } h2 { font-size: var(--font-size-2xl); }
        h3 { font-size: var(--font-size-xl); } h4 { font-size: var(--font-size-lg); }
        p { margin: 0; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: var(--space-8) var(--space-16); border-radius: var(--radius-base); font-size: var(--font-size-base); font-weight: 500; cursor: pointer; transition: all var(--duration-normal) var(--ease-standard); border: none; text-decoration: none; }
        .btn:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--color-focus-ring); }
        .btn--primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn--primary:hover { background: var(--color-primary-hover); }
        .btn--outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn--outline:hover { background: var(--color-secondary); }
        .btn--danger { background: var(--color-danger); color: white; }
        .btn > span:not(:last-child) { margin-right: var(--space-8); }
        .btn--sm { padding: var(--space-4) var(--space-8); font-size: var(--font-size-sm); }


        .form-control { display: block; width: 100%; padding: var(--space-8) var(--space-12); font-size: var(--font-size-base); color: var(--color-text); background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); }
        .form-label { display: block; margin-bottom: var(--space-8); font-weight: 500; font-size: var(--font-size-sm); }
        .form-group { margin-bottom: var(--space-16); }
        
        .hidden { display: none !important; }

        /* App Specific Styles */
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-background); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: var(--space-16); }
        @keyframes spin { to { transform: rotate(360deg); } }

        .app-container { min-height: 100vh; background: var(--color-background); }
        .app-header { background: var(--color-primary); color: var(--color-btn-primary-text); padding: var(--space-16); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: var(--container-lg); margin: 0 auto; }
        .header-title h1 { color: var(--color-btn-primary-text); font-size: var(--font-size-xl); }
        .header-title p { color: rgba(255, 255, 255, 0.8); font-size: var(--font-size-sm); }
        [data-color-scheme="dark"] .header-title p { color: rgba(0, 0, 0, 0.8); }
        .header-actions { display: flex; gap: var(--space-8); }
        .btn-icon { background: rgba(255, 255, 255, 0.2); border: none; border-radius: var(--radius-full); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: var(--color-btn-primary-text); cursor: pointer; transition: background var(--duration-normal); font-size: 1.2rem; }
        .btn-icon:hover { background: rgba(255, 255, 255, 0.3); }
        [data-color-scheme="dark"] .btn-icon { background: rgba(0, 0, 0, 0.2); }
        [data-color-scheme="dark"] .btn-icon:hover { background: rgba(0, 0, 0, 0.3); }

        .main-content { max-width: var(--container-lg); margin: 0 auto; padding: var(--space-24) var(--space-16); }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--space-16); margin-bottom: var(--space-32); }
        .stat-card { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-20); display: flex; align-items: center; gap: var(--space-16); box-shadow: var(--shadow-sm); border: 1px solid var(--color-border); }
        .stat-icon { font-size: 2rem; opacity: 0.8; }
        .stat-info h3 { font-size: var(--font-size-2xl); font-weight: 700; color: var(--color-primary); }
        .stat-info p { font-size: var(--font-size-sm); color: var(--color-text-secondary); }

        .section { margin-bottom: var(--space-32); }
        .section h2 { margin-bottom: var(--space-16); color: var(--color-text); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-16); flex-wrap: wrap; gap: 16px; }
        .section-header-actions { display: flex; gap: var(--space-8); }

        .classes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-16); }
        .class-card { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-20); border: 1px solid var(--color-border); cursor: pointer; transition: all var(--duration-normal); position: relative; overflow: hidden; }
        .class-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--color-primary); }
        .class-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .class-card h3 { margin-bottom: var(--space-8); }
        .class-card p { color: var(--color-text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--space-12); }
        
        .students-list { display: flex; flex-direction: column; gap: var(--space-8); margin-bottom: var(--space-24); }
        .student-item { background: var(--color-surface); border-radius: var(--radius-base); padding: var(--space-16); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: transform 0.3s ease, background 0.1s linear; touch-action: pan-y; position: relative; overflow: hidden; }
        .student-item.swiping { transition: none; } /* Disable transition while swiping */
        .student-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #e0e0e0; transition: background var(--duration-normal); }
        .student-item.presente::before { background: #4CAF50; } .student-item.ausente::before { background: #F44336; } .student-item.atrasado::before { background: #FF9800; } .student-item.justificado::before { background: #2196F3; }
        .student-info { display: flex; align-items: center; gap: var(--space-12); }
        .student-number { background: var(--color-secondary); color: var(--color-text); width: 32px; height: 32px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-sm); font-weight: 500; }
        .student-name { font-weight: 500; }
        .student-status { display: flex; align-items: center; gap: var(--space-8); font-size: var(--font-size-sm); }
        .status-icon { font-size: var(--font-size-lg); }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 1; transition: opacity var(--duration-normal); }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content { background: var(--color-surface); border-radius: var(--radius-lg); max-width: 500px; width: 90%; box-shadow: var(--shadow-lg); transform: scale(0.95); opacity: 0; transition: all var(--duration-normal) var(--ease-standard); max-height: 85vh; display: flex; flex-direction: column; }
        .modal:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .modal-header { padding: var(--space-16); border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: var(--space-16); overflow-y: auto; }
        .modal-footer { padding: var(--space-16); border-top: 1px solid var(--color-border); display: flex; justify-content: flex-end; gap: var(--space-12); }
        
        .attendance-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-12); margin-bottom: var(--space-20); }
        .attendance-btn { padding: var(--space-12); border-radius: var(--radius-base); border: 2px solid transparent; cursor: pointer; transition: transform var(--duration-normal); display: flex; align-items: center; justify-content: center; gap: var(--space-8); }
        .attendance-btn.selected { border-color: var(--color-primary); transform: scale(1.05); }
        .attendance-btn[data-status="presente"] { background: #4CAF50; color: white; } .attendance-btn[data-status="ausente"] { background: #F44336; color: white; } .attendance-btn[data-status="atrasado"] { background: #FF9800; color: white; } .attendance-btn[data-status="justificado"] { background: #2196F3; color: white; }

        .setting-item { margin-bottom: var(--space-20); }
        .theme-options { display: flex; gap: var(--space-12); }
        .theme-options .btn { flex: 1; border: 1px solid var(--color-border); }
        .theme-options .btn.active { background: var(--color-primary); color: var(--color-btn-primary-text); border-color: var(--color-primary); }

        .management-list { display: flex; flex-direction: column; gap: var(--space-8); }
        .management-item { background: var(--color-secondary); padding: var(--space-12); border-radius: var(--radius-base); display: flex; justify-content: space-between; align-items: center; }
        .management-item-actions { display: flex; gap: var(--space-8); }

        .fab { position: fixed; bottom: var(--space-24); right: var(--space-24); width: 56px; height: 56px; border-radius: var(--radius-full); background: var(--color-primary); color: var(--color-btn-primary-text); border: none; box-shadow: var(--shadow-lg); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-2xl); transition: transform var(--duration-normal); z-index: 100; }
        .fab:hover { transform: scale(1.1); }

        .toast { position: fixed; bottom: var(--space-24); left: 50%; transform: translateX(-50%) translateY(100px); background: #262828; color: white; padding: var(--space-12) var(--space-20); border-radius: var(--radius-full); font-size: var(--font-size-sm); z-index: 1001; transition: transform var(--duration-normal); }
        .toast:not(.hidden) { transform: translateX(-50%) translateY(0); }

        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-16); margin-top: var(--space-24); }

        .reports-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-24); margin-bottom: var(--space-32); }
        .report-card { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-20); border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-16); margin-top: var(--space-16); }
        .summary-item { text-align: center; padding: var(--space-16); background: var(--color-secondary); border-radius: var(--radius-base); }
        .summary-number { font-size: var(--font-size-2xl); font-weight: 700; color: var(--color-primary); }
        .summary-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-4); }

        .history-filters { display: flex; gap: var(--space-16); flex-wrap: wrap; }
        .history-list { display: flex; flex-direction: column; gap: var(--space-16); }
        .history-item { background: var(--color-surface); border-radius: var(--radius-base); padding: var(--space-16); border: 1px solid var(--color-border); }
        .history-header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-12); }
        .history-date { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .history-stats { display: flex; gap: var(--space-16); font-size: var(--font-size-sm); }
        .history-stat { display: flex; align-items: center; gap: var(--space-4); }


        @media (max-width: 768px) { .attendance-actions, .quick-actions { flex-direction: column; } .attendance-actions .btn, .quick-actions .btn { width: 100%; } }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p data-translate="loading">A carregar...</p>
    </div>

    <!-- Main App Container -->
    <div id="app" class="app-container hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <button id="back-btn" class="btn-icon hidden">
                    <span>&larr;</span>
                </button>
                <div class="header-title">
                    <h1 id="page-title" data-translate="appTitle">Registo de Presen√ßas</h1>
                    <p id="page-subtitle"></p>
                </div>
                <div class="header-actions">
                    <button id="settings-btn" class="btn-icon" title="Configura√ß√µes">
                        <span>&#9881;</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view active">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3 id="total-students">0</h3>
                            <p data-translate="totalStudents">Total de Alunos</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">&#10003;</div>
                        <div class="stat-info">
                            <h3 id="present-today">0</h3>
                            <p data-translate="presentToday">Presentes Hoje</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">&#10007;</div>
                        <div class="stat-info">
                            <h3 id="absent-today">0</h3>
                            <p data-translate="absentToday">Ausentes Hoje</p>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h2 data-translate="myClasses">As Minhas Turmas</h2>
                    <div id="classes-grid" class="classes-grid"></div>
                </div>
                <div class="section">
                    <h2 data-translate="quickAccess">Acesso R√°pido</h2>
                    <div class="quick-actions">
                        <button id="show-reports-btn" class="btn btn--primary"><span >üìä</span> <span data-translate="reports">Relat√≥rios</span></button>
                        <button id="show-history-btn" class="btn btn--primary"><span>üìã</span> <span data-translate="history">Hist√≥rico</span></button>
                        <button id="show-individual-report-btn" class="btn btn--primary"><span>üë§</span> <span data-translate="studentReport">Relat√≥rio de Aluno</span></button>
                    </div>
                </div>
            </div>

            <!-- Attendance View -->
            <div id="attendance-view" class="view">
                <div class="section-header">
                    <h2 id="attendance-class-name"></h2>
                </div>
                <div id="students-list" class="students-list"></div>
                <div class="section-header-actions" style="margin-top: 16px;">
                    <button id="mark-all-present-btn" class="btn btn--primary"><span>&#10003;</span> <span data-translate="markAllPresent">Marcar Todos Presentes</span></button>
                </div>
            </div>
            
            <!-- Management View -->
            <div id="management-view" class="view">
                <div class="section-header">
                    <h2 data-translate="manageClasses">Gerir Turmas</h2>
                    <button id="add-class-btn" class="btn btn--primary"><span>+</span><span data-translate="addClass">Adicionar Turma</span></button>
                </div>
                <div id="management-list" class="management-list"></div>
            </div>

            <!-- Reports View -->
            <div id="reports-view" class="view">
                <div class="section-header">
                    <h2 data-translate="weeklyReports">Relat√≥rios Semanais</h2>
                    <div class="section-header-actions">
                        <input type="week" id="week-picker" class="form-control" style="max-width: 200px;">
                        <button id="export-report-btn" class="btn btn--outline"><span>&darr;</span> <span data-translate="exportCsv">Exportar (CSV)</span></button>
                    </div>
                </div>
                <div class="reports-grid">
                    <div class="report-card">
                        <h3 data-translate="weekStats">Estat√≠sticas da Semana</h3>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="weekly-chart"></canvas>
                        </div>
                    </div>
                    <div class="report-card">
                        <h3 data-translate="weeklySummary">Resumo Semanal</h3>
                        <div id="weekly-summary" class="summary-grid"></div>
                    </div>
                </div>
            </div>

            <!-- History View -->
            <div id="history-view" class="view">
                <div class="section-header">
                    <h2 data-translate="attendanceHistory">Hist√≥rico de Presen√ßas</h2>
                    <button id="export-history-btn" class="btn btn--outline"><span>&darr;</span> <span data-translate="exportViewCsv">Exportar Vista (CSV)</span></button>
                </div>
                <div class="history-filters">
                    <select id="class-filter" class="form-control"><option value="" data-translate="allClasses">Todas as turmas</option></select>
                    <input type="date" id="date-filter" class="form-control">
                </div>
                <div id="history-list" class="history-list" style="margin-top: 24px;"></div>
            </div>

            <!-- Individual Report View -->
            <div id="individual-report-view" class="view">
                <div class="section-header">
                    <h2 data-translate="individualStudentReport">Relat√≥rio Individual de Aluno</h2>
                    <button id="export-individual-report-btn" class="btn btn--outline"><span>&darr;</span> <span data-translate="exportCsv">Exportar (CSV)</span></button>
                </div>
                <div class="history-filters">
                    <select id="individual-report-class-filter" class="form-control"><option value="" data-translate="selectClass">Selecione uma turma...</option></select>
                    <select id="individual-report-student-filter" class="form-control" disabled><option value="" data-translate="selectStudent">Selecione um aluno...</option></select>
                    <input type="date" id="individual-report-start-date" class="form-control">
                    <input type="date" id="individual-report-end-date" class="form-control">
                </div>
                <div id="individual-report-content" class="hidden" style="margin-top: 24px;">
                    <div class="report-card">
                        <h3 id="individual-report-student-name"></h3>
                        <div id="individual-report-summary" class="summary-grid"></div>
                    </div>
                    <div id="individual-report-list" class="history-list" style="margin-top: 24px;"></div>
                </div>
            </div>
        </main>

        <!-- FAB -->
        <button id="fab" class="fab" title="Registo R√°pido"><span>&#10003;</span></button>
    </div>

    <!-- Modals -->
    <div id="student-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-student-name"></h3>
                <button id="modal-close-btn" class="btn-icon"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div id="modal-attendance-options" class="attendance-options">
                    <button class="btn attendance-btn" data-status="presente"><span>&#10003;</span> <span data-translate="present">Presente</span></button>
                    <button class="btn attendance-btn" data-status="ausente"><span>&#10007;</span> <span data-translate="absent">Ausente</span></button>
                    <button class="btn attendance-btn" data-status="atrasado"><span>&#9200;</span> <span data-translate="late">Atrasado</span></button>
                    <button class="btn attendance-btn" data-status="justificado"><span>&#128196;</span> <span data-translate="justified">Justificado</span></button>
                </div>
                <div class="note-section">
                    <label class="form-label" data-translate="notes">Observa√ß√µes</label>
                    <textarea id="student-note" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="btn btn--outline" data-translate="cancel">Cancelar</button>
                <button id="modal-save-btn" class="btn btn--primary" data-translate="save">Guardar</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-translate="settings">Configura√ß√µes</h3>
                <button id="settings-modal-close-btn" class="btn-icon"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <label for="school-name-input" class="form-label" data-translate="schoolName">Nome da Escola</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="school-name-input" class="form-control">
                        <button type="button" id="save-school-name-btn" class="btn btn--primary" data-translate="save">Guardar</button>
                    </div>
                </div>
                <div class="setting-item">
                    <label class="form-label" data-translate="appTheme">Tema da Aplica√ß√£o</label>
                    <div class="theme-options">
                        <button id="theme-light-btn" class="btn btn--outline" data-translate="light">Claro</button>
                        <button id="theme-dark-btn" class="btn btn--outline" data-translate="dark">Escuro</button>
                    </div>
                </div>
                 <div class="setting-item">
                    <label class="form-label" data-translate="language">Idioma</label>
                    <div class="theme-options">
                        <button id="lang-pt-btn" class="btn btn--outline">Portugu√™s</button>
                        <button id="lang-en-btn" class="btn btn--outline">English</button>
                        <button id="lang-es-btn" class="btn btn--outline">Espa√±ol</button>
                    </div>
                </div>
                <hr style="border: none; border-top: 1px solid var(--color-border); margin: var(--space-20) 0;">
                <div class="setting-item">
                    <label class="form-label" data-translate="dataManagement">Gest√£o de Dados</label>
                    <button id="manage-classes-btn" class="btn btn--primary" data-translate="manageClassesStudents">Gerir Turmas e Alunos</button>
                </div>
                <hr style="border: none; border-top: 1px solid var(--color-border); margin: var(--space-20) 0;">
                <div class="setting-item">
                    <label class="form-label" data-translate="backupRestore">Backup e Restauro</label>
                    <div class="quick-actions">
                        <button id="backup-data-btn" class="btn btn--outline"><span>&darr;</span> <span data-translate="exportAllData">Exportar Todos os Dados</span></button>
                        <button id="restore-data-btn" class="btn btn--outline"><span>&uarr;</span> <span data-translate="importData">Importar Dados</span></button>
                        <input type="file" id="restore-file-input" class="hidden" accept=".json">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="class-editor-modal" class="modal hidden">
        <div class="modal-content">
            <form id="class-editor-form">
                <div class="modal-header">
                    <h3 id="class-editor-title"></h3>
                    <button type="button" class="btn-icon class-editor-close-btn"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-class-id">
                    <div class="form-group"><label for="edit-class-name" class="form-label" data-translate="className">Nome da Turma</label><input type="text" id="edit-class-name" class="form-control" required></div>
                    <div class="form-group"><label for="edit-class-subject" class="form-label" data-translate="subject">Disciplina</label><input type="text" id="edit-class-subject" class="form-control"></div>
                    <div class="form-group"><label for="edit-class-teacher" class="form-label" data-translate="teacher">Professor</label><input type="text" id="edit-class-teacher" class="form-control"></div>
                    <div class="section-header">
                        <h4 data-translate="students">Alunos</h4>
                        <div class="section-header-actions">
                             <button type="button" id="import-students-btn" class="btn btn--outline btn--sm"><span>&uarr;</span> <span data-translate="import">Importar</span></button>
                             <button type="button" id="add-student-btn" class="btn btn--primary btn--sm"><span>+</span> <span data-translate="add">Adicionar</span></button>
                        </div>
                    </div>
                    <div id="class-editor-student-list" class="management-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--outline class-editor-close-btn" data-translate="cancel">Cancelar</button>
                    <button type="submit" class="btn btn--primary" data-translate="saveClass">Guardar Turma</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="student-editor-modal" class="modal hidden">
        <div class="modal-content">
             <form id="student-editor-form">
                <div class="modal-header"><h3 id="student-editor-title"></h3><button type="button" class="btn-icon student-editor-close-btn"><span>&times;</span></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-student-id"><input type="hidden" id="edit-student-class-id">
                    <div class="form-group"><label for="edit-student-name" class="form-label" data-translate="studentName">Nome do Aluno</label><input type="text" id="edit-student-name" class="form-control" required></div>
                    <div class="form-group"><label for="edit-student-number" class="form-label" data-translate="number">N√∫mero</label><input type="number" id="edit-student-number" class="form-control" required></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--outline student-editor-close-btn" data-translate="cancel">Cancelar</button>
                    <button type="submit" class="btn btn--primary" data-translate="saveStudent">Guardar Aluno</button>
                </div>
            </form>
        </div>
    </div>

    <div id="student-importer-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 data-translate="importStudents">Importar Alunos</h3><button type="button" class="btn-icon student-importer-close-btn"><span>&times;</span></button></div>
            <div class="modal-body">
                <p data-translate="importStudentsHelp">Cole a lista de alunos abaixo. Use o formato: <strong>N√∫mero, Nome</strong> (um aluno por linha).</p>
                <div class="form-group"><textarea id="import-student-list" class="form-control" rows="10" placeholder="1, Ana Silva&#10;2, Bruno Costa&#10;..."></textarea></div>
                <div id="import-preview-container" class="hidden"><h4 data-translate="preview">Pr√©-visualiza√ß√£o</h4><div id="import-preview" class="management-list"></div></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--outline student-importer-close-btn" data-translate="cancel">Cancelar</button>
                <button type="button" id="import-students-confirm-btn" class="btn btn--primary" data-translate="import">Importar</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3 id="confirm-title"></h3></div>
            <div class="modal-body"><p id="confirm-message"></p></div>
            <div class="modal-footer">
                <button id="confirm-cancel-btn" class="btn btn--outline" data-translate="cancel">Cancelar</button>
                <button id="confirm-ok-btn" class="btn btn--danger" data-translate="confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden"><span id="toast-message"></span></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        class AttendanceApp {
            constructor() {
                this.db = null;
                this.currentClassId = null; // Use ID for context
                this.currentStudentId = null; // Use ID for context
                this.data = { turmas: [] };
                this.schoolName = 'A Minha Escola';
                this.attendanceData = [];
                this.charts = {};
                this.currentLanguage = 'pt';

                // Swipe gesture properties
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.touchEndX = 0;
                this.touchEndY = 0;
                this.swipedItem = null;
                
                this.translations = {
                    pt: {
                        loading: "A carregar...", appTitle: "Registo de Presen√ßas", totalStudents: "Total de Alunos",
                        presentToday: "Presentes Hoje", absentToday: "Ausentes Hoje", myClasses: "As Minhas Turmas",
                        quickAccess: "Acesso R√°pido", reports: "Relat√≥rios", history: "Hist√≥rico", studentReport: "Relat√≥rio de Aluno",
                        markAllPresent: "Marcar Todos Presentes", manageClasses: "Gerir Turmas", addClass: "Adicionar Turma",
                        weeklyReports: "Relat√≥rios Semanais", exportCsv: "Exportar (CSV)", weekStats: "Estat√≠sticas da Semana",
                        weeklySummary: "Resumo Semanal", attendanceHistory: "Hist√≥rico de Presen√ßas", exportViewCsv: "Exportar Vista (CSV)",
                        allClasses: "Todas as turmas", individualStudentReport: "Relat√≥rio Individual de Aluno", selectClass: "Selecione uma turma...",
                        selectStudent: "Selecione um aluno...", present: "Presente", absent: "Ausente", late: "Atrasado",
                        justified: "Justificado", notes: "Observa√ß√µes", cancel: "Cancelar", save: "Guardar",
                        settings: "Configura√ß√µes", schoolName: "Nome da Escola", appTheme: "Tema da Aplica√ß√£o",
                        light: "Claro", dark: "Escuro", language: "Idioma", dataManagement: "Gest√£o de Dados",
                        manageClassesStudents: "Gerir Turmas e Alunos", backupRestore: "Backup e Restauro",
                        exportAllData: "Exportar Todos os Dados", importData: "Importar Dados", className: "Nome da Turma",
                        subject: "Disciplina", teacher: "Professor", students: "Alunos", import: "Importar", add: "Adicionar",
                        saveClass: "Guardar Turma", studentName: "Nome do Aluno", number: "N√∫mero", saveStudent: "Guardar Aluno",
                        importStudents: "Importar Alunos", importStudentsHelp: "Cole a lista de alunos abaixo. Use o formato: N√∫mero, Nome (um aluno por linha).",
                        preview: "Pr√©-visualiza√ß√£o", confirm: "Confirmar", schoolNameUpdated: "Nome da escola atualizado.",
                        addNewClass: "Adicionar Nova Turma", editClass: "Editar Turma", classSaved: "Turma guardada com sucesso.",
                        deleteClass: "Apagar Turma", deleteClassConfirm: "Tem a certeza que quer apagar esta turma e todos os seus alunos? Esta a√ß√£o √© irrevers√≠vel.",
                        classDeleted: "Turma apagada.", addStudent: "Adicionar Aluno", editStudent: "Editar Aluno", studentSaved: "Aluno guardado com sucesso.",
                        deleteStudent: "Apagar Aluno", deleteStudentConfirm: "Tem a certeza que quer apagar este aluno?",
                        studentDeleted: "Aluno apagado.", ignoreExistingNum: "N√∫mero j√° existe, ignorar.", studentsImported: "alunos importados.",
                        noNewStudentsToImport: "Nenhum aluno novo para importar.", noClassesFound: "Nenhuma turma encontrada. Adicione uma nas configura√ß√µes.",
                        noSubject: "Sem disciplina", noClassesAddOne: "N√£o existem turmas. Adicione uma para come√ßar.",
                        unmarked: "N√£o marcado", selectStatusError: "Por favor, selecione um estado.", allMarkedPresent: "Todos os alunos foram marcados como presentes.",
                        presents: "Presentes", absences: "Faltas", lates: "Atrasos", attendanceRate: "Taxa de Presen√ßa",
                        noRecordsFound: "Nenhum registo encontrado para os filtros selecionados.", reportFor: "Relat√≥rio para",
                        noRecordsInPeriod: "Nenhum registo para este aluno no per√≠odo selecionado.", selectStudentToExport: "Selecione um aluno para exportar o relat√≥rio.",
                        noDataToExport: "N√£o existem dados para exportar.", exportComplete: "Exporta√ß√£o conclu√≠da.", backupCreated: "Backup criado com sucesso.",
                        backupError: "Ocorreu um erro ao criar o backup.", restoreData: "Restaurar Dados",
                        restoreDataConfirm: "Isto ir√° substituir todos os dados atuais. Tem a certeza?",
                        restoreErrorInvalidFile: "Erro ao restaurar. Ficheiro de backup inv√°lido ou corrompido.",
                        restoreSuccess: "Dados restaurados com sucesso. A aplica√ß√£o ser√° recarregada.", restoreFatalError: "Ocorreu um erro fatal durante o restauro."
                    },
                    en: {
                        loading: "Loading...", appTitle: "Attendance Register", totalStudents: "Total Students",
                        presentToday: "Present Today", absentToday: "Absent Today", myClasses: "My Classes",
                        quickAccess: "Quick Access", reports: "Reports", history: "History", studentReport: "Student Report",
                        markAllPresent: "Mark All Present", manageClasses: "Manage Classes", addClass: "Add Class",
                        weeklyReports: "Weekly Reports", exportCsv: "Export (CSV)", weekStats: "Week Statistics",
                        weeklySummary: "Weekly Summary", attendanceHistory: "Attendance History", exportViewCsv: "Export View (CSV)",
                        allClasses: "All classes", individualStudentReport: "Individual Student Report", selectClass: "Select a class...",
                        selectStudent: "Select a student...", present: "Present", absent: "Absent", late: "Late",
                        justified: "Justified", notes: "Notes", cancel: "Cancel", save: "Save",
                        settings: "Settings", schoolName: "School Name", appTheme: "App Theme",
                        light: "Light", dark: "Dark", language: "Language", dataManagement: "Data Management",
                        manageClassesStudents: "Manage Classes and Students", backupRestore: "Backup & Restore",
                        exportAllData: "Export All Data", importData: "Import Data", className: "Class Name",
                        subject: "Subject", teacher: "Teacher", students: "Students", import: "Import", add: "Add",
                        saveClass: "Save Class", studentName: "Student Name", number: "Number", saveStudent: "Save Student",
                        importStudents: "Import Students", importStudentsHelp: "Paste the list of students below. Use the format: Number, Name (one student per line).",
                        preview: "Preview", confirm: "Confirm", schoolNameUpdated: "School name updated.",
                        addNewClass: "Add New Class", editClass: "Edit Class", classSaved: "Class saved successfully.",
                        deleteClass: "Delete Class", deleteClassConfirm: "Are you sure you want to delete this class and all its students? This action is irreversible.",
                        classDeleted: "Class deleted.", addStudent: "Add Student", editStudent: "Edit Student", studentSaved: "Student saved successfully.",
                        deleteStudent: "Delete Student", deleteStudentConfirm: "Are you sure you want to delete this student?",
                        studentDeleted: "Student deleted.", ignoreExistingNum: "Number already exists, ignoring.", studentsImported: "students imported.",
                        noNewStudentsToImport: "No new students to import.", noClassesFound: "No classes found. Add one in the settings.",
                        noSubject: "No subject", noClassesAddOne: "No classes exist. Add one to get started.",
                        unmarked: "Unmarked", selectStatusError: "Please select a status.", allMarkedPresent: "All students have been marked as present.",
                        presents: "Presents", absences: "Absences", lates: "Lates", attendanceRate: "Attendance Rate",
                        noRecordsFound: "No records found for the selected filters.", reportFor: "Report for",
                        noRecordsInPeriod: "No records for this student in the selected period.", selectStudentToExport: "Select a student to export the report.",
                        noDataToExport: "No data to export.", exportComplete: "Export complete.", backupCreated: "Backup created successfully.",
                        backupError: "An error occurred while creating the backup.", restoreData: "Restore Data",
                        restoreDataConfirm: "This will overwrite all current data. Are you sure?",
                        restoreErrorInvalidFile: "Error restoring. Invalid or corrupt backup file.",
                        restoreSuccess: "Data restored successfully. The application will now reload.", restoreFatalError: "A fatal error occurred during the restore."
                    },
                    es: {
                        loading: "Cargando...", appTitle: "Registro de Asistencia", totalStudents: "Total de Alumnos",
                        presentToday: "Presentes Hoy", absentToday: "Ausentes Hoy", myClasses: "Mis Clases",
                        quickAccess: "Acceso R√°pido", reports: "Informes", history: "Historial", studentReport: "Informe de Alumno",
                        markAllPresent: "Marcar Todos Presentes", manageClasses: "Gestionar Clases", addClass: "A√±adir Clase",
                        weeklyReports: "Informes Semanales", exportCsv: "Exportar (CSV)", weekStats: "Estad√≠sticas de la Semana",
                        weeklySummary: "Resumen Semanal", attendanceHistory: "Historial de Asistencia", exportViewCsv: "Exportar Vista (CSV)",
                        allClasses: "Todas las clases", individualStudentReport: "Informe Individual de Alumno", selectClass: "Seleccione una clase...",
                        selectStudent: "Seleccione un alumno...", present: "Presente", absent: "Ausente", late: "Tarde",
                        justified: "Justificado", notes: "Notas", cancel: "Cancelar", save: "Guardar",
                        settings: "Configuraci√≥n", schoolName: "Nombre de la Escuela", appTheme: "Tema de la Aplicaci√≥n",
                        light: "Claro", dark: "Oscuro", language: "Idioma", dataManagement: "Gesti√≥n de Datos",
                        manageClassesStudents: "Gestionar Clases y Alumnos", backupRestore: "Copia de Seguridad y Restauraci√≥n",
                        exportAllData: "Exportar Todos los Datos", importData: "Importar Datos", className: "Nombre de la Clase",
                        subject: "Asignatura", teacher: "Profesor", students: "Alumnos", import: "Importar", add: "A√±adir",
                        saveClass: "Guardar Clase", studentName: "Nombre del Alumno", number: "N√∫mero", saveStudent: "Guardar Alumno",
                        importStudents: "Importar Alumnos", importStudentsHelp: "Pegue la lista de alumnos a continuaci√≥n. Use el formato: N√∫mero, Nombre (un alumno por l√≠nea).",
                        preview: "Vista Previa", confirm: "Confirmar", schoolNameUpdated: "Nombre de la escuela actualizado.",
                        addNewClass: "A√±adir Nueva Clase", editClass: "Editar Clase", classSaved: "Clase guardada con √©xito.",
                        deleteClass: "Eliminar Clase", deleteClassConfirm: "¬øEst√° seguro de que quiere eliminar esta clase y todos sus alumnos? Esta acci√≥n es irreversible.",
                        classDeleted: "Clase eliminada.", addStudent: "A√±adir Alumno", editStudent: "Editar Alumno", studentSaved: "Alumno guardado con √©xito.",
                        deleteStudent: "Eliminar Alumno", deleteStudentConfirm: "¬øEst√° seguro de que quiere eliminar a este alumno?",
                        studentDeleted: "Alumno eliminado.", ignoreExistingNum: "El n√∫mero ya existe, se ignora.", studentsImported: "alumnos importados.",
                        noNewStudentsToImport: "No hay nuevos alumnos para importar.", noClassesFound: "No se encontraron clases. A√±ada una en la configuraci√≥n.",
                        noSubject: "Sin asignatura", noClassesAddOne: "No existen clases. A√±ada una para empezar.",
                        unmarked: "Sin marcar", selectStatusError: "Por favor, seleccione un estado.", allMarkedPresent: "Todos los alumnos han sido marcados como presentes.",
                        presents: "Presentes", absences: "Ausencias", lates: "Retrasos", attendanceRate: "Tasa de Asistencia",
                        noRecordsFound: "No se encontraron registros para los filtros seleccionados.", reportFor: "Informe para",
                        noRecordsInPeriod: "No hay registros para este alumno en el per√≠odo seleccionado.", selectStudentToExport: "Seleccione un alumno para exportar el informe.",
                        noDataToExport: "No hay datos para exportar.", exportComplete: "Exportaci√≥n completa.", backupCreated: "Copia de seguridad creada con √©xito.",
                        backupError: "Ocurri√≥ un error al crear la copia de seguridad.", restoreData: "Restaurar Datos",
                        restoreDataConfirm: "Esto sobrescribir√° todos los datos actuales. ¬øEst√° seguro?",
                        restoreErrorInvalidFile: "Error al restaurar. Archivo de copia de seguridad inv√°lido o corrupto.",
                        restoreSuccess: "Datos restaurados con √©xito. La aplicaci√≥n se recargar√°.", restoreFatalError: "Ocurri√≥ un error fatal durante la restauraci√≥n."
                    }
                };

                this.defaultData = {
                    "turmas": [
                        { "id": "7a", "nome": "7¬∫ A", "disciplina": "Matem√°tica", "professor": "Prof. Ana Silva", "alunos": [
                            {"id": "s1", "numero": 1, "nome": "Francisco Pereira"}, {"id": "s2", "numero": 2, "nome": "Maria Santos"}
                        ]},
                        { "id": "8b", "nome": "8¬∫ B", "disciplina": "Portugu√™s", "professor": "Prof. Carlos Mendes", "alunos": [
                            {"id": "s21", "numero": 1, "nome": "Martim Silva"}, {"id": "s22", "numero": 2, "nome": "Lara Costa"}
                        ]}
                    ]
                };

                this.init();
            }

            async init() {
                this.loadAppSettings();
                this.setupEventListeners();
                await this.initDB();
                await this.loadAppDataFromDB();
                await this.loadAttendanceDataFromDB();
                this.hideLoadingScreen();
                this.showView('dashboard');
            }

            hideLoadingScreen() {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
            }
            
            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('AttendanceAppDB_v3', 4);
                    request.onerror = (e) => {
                        console.error("Database error: ", e.target.errorCode);
                        reject("Erro ao abrir a base de dados: " + e.target.errorCode);
                    };
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('config')) db.createObjectStore('config', { keyPath: 'key' });
                        if (!db.objectStoreNames.contains('attendance')) {
                            const store = db.createObjectStore('attendance', { keyPath: 'id' });
                            store.createIndex('date', 'date', { unique: false });
                            store.createIndex('classId', 'classId', { unique: false });
                            store.createIndex('studentId', 'studentId', { unique: false });
                        }
                    };
                });
            }

            // --- EVENT LISTENERS ---
            setupEventListeners() {
                // Navigation
                document.getElementById('back-btn').addEventListener('click', () => this.showView('dashboard'));
                document.getElementById('settings-btn').addEventListener('click', () => this.openSettingsModal());
                document.getElementById('fab').addEventListener('click', () => this.quickAttendance());

                // Dashboard Actions
                document.getElementById('show-reports-btn').addEventListener('click', () => this.showReports());
                document.getElementById('show-history-btn').addEventListener('click', () => this.showHistory());
                document.getElementById('show-individual-report-btn').addEventListener('click', () => this.showIndividualReport());

                // Class Grid & Attendance
                document.getElementById('classes-grid').addEventListener('click', (e) => {
                    const card = e.target.closest('.class-card');
                    if (card) this.openClass(card.dataset.classId);
                });
                const studentList = document.getElementById('students-list');
                studentList.addEventListener('click', (e) => {
                    if (this.isSwiping) {
                        this.isSwiping = false;
                        return;
                    }
                    const item = e.target.closest('.student-item');
                    if (item) this.openStudentModal(item.dataset.studentId);
                });
                studentList.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
                studentList.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: true });
                studentList.addEventListener('touchend', (e) => this.handleTouchEnd(e));

                document.getElementById('mark-all-present-btn').addEventListener('click', () => this.markAllPresent());

                // Modals
                document.getElementById('settings-modal-close-btn').addEventListener('click', () => this.closeSettingsModal());
                document.getElementById('save-school-name-btn').addEventListener('click', () => this.saveSchoolName());
                document.getElementById('theme-light-btn').addEventListener('click', () => this.setTheme('light'));
                document.getElementById('theme-dark-btn').addEventListener('click', () => this.setTheme('dark'));
                document.getElementById('lang-pt-btn').addEventListener('click', () => this.setLanguage('pt'));
                document.getElementById('lang-en-btn').addEventListener('click', () => this.setLanguage('en'));
                document.getElementById('lang-es-btn').addEventListener('click', () => this.setLanguage('es'));
                document.getElementById('manage-classes-btn').addEventListener('click', () => { this.closeSettingsModal(); this.showView('management'); });
                
                document.getElementById('modal-close-btn').addEventListener('click', () => this.closeStudentModal());
                document.getElementById('modal-cancel-btn').addEventListener('click', () => this.closeStudentModal());
                document.getElementById('modal-save-btn').addEventListener('click', () => this.saveStudentAttendance());
                document.getElementById('modal-attendance-options').addEventListener('click', (e) => {
                    const button = e.target.closest('.attendance-btn');
                    if(button) this.selectAttendanceStatus(button.dataset.status);
                });

                // Management
                document.getElementById('add-class-btn').addEventListener('click', () => this.openClassEditor());
                document.getElementById('management-list').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    if (target.matches('.edit-class-btn')) this.openClassEditor(target.dataset.classId);
                    if (target.matches('.delete-class-btn')) this.deleteClass(target.dataset.classId);
                });
                document.getElementById('class-editor-form').addEventListener('submit', (e) => this.saveClass(e));
                document.querySelectorAll('.class-editor-close-btn').forEach(btn => btn.addEventListener('click', () => this.closeClassEditor()));
                document.getElementById('add-student-btn').addEventListener('click', () => this.openStudentEditor());
                document.getElementById('import-students-btn').addEventListener('click', () => this.openStudentImporter());
                document.getElementById('class-editor-student-list').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    if (target.matches('.edit-student-btn')) this.openStudentEditor(target.dataset.studentId);
                    if (target.matches('.delete-student-btn')) this.deleteStudent(target.dataset.studentId);
                });
                document.getElementById('student-editor-form').addEventListener('submit', (e) => this.saveStudent(e));
                document.querySelectorAll('.student-editor-close-btn').forEach(btn => btn.addEventListener('click', () => this.closeStudentEditor()));
                document.querySelectorAll('.student-importer-close-btn').forEach(btn => btn.addEventListener('click', () => this.closeStudentImporter()));
                document.getElementById('import-student-list').addEventListener('input', () => this.previewStudentImport());
                document.getElementById('import-students-confirm-btn').addEventListener('click', () => this.handleStudentImport());

                // Reports & History
                document.getElementById('week-picker').addEventListener('change', (e) => this.updateWeeklyReport(e.target.value));
                document.getElementById('class-filter').addEventListener('change', () => this.filterHistory());
                document.getElementById('date-filter').addEventListener('change', () => this.filterHistory());
                document.getElementById('export-report-btn').addEventListener('click', () => this.exportWeekReportToCSV());
                document.getElementById('export-history-btn').addEventListener('click', () => this.exportHistoryToCSV());
                document.getElementById('export-individual-report-btn').addEventListener('click', () => this.exportIndividualReportToCSV());
                
                // Individual Report Filters
                document.getElementById('individual-report-class-filter').addEventListener('change', (e) => this.populateIndividualStudentFilter(e.target.value));
                document.getElementById('individual-report-student-filter').addEventListener('change', () => this.generateIndividualReport());
                document.getElementById('individual-report-start-date').addEventListener('change', () => this.generateIndividualReport());
                document.getElementById('individual-report-end-date').addEventListener('change', () => this.generateIndividualReport());

                // Backup & Restore
                document.getElementById('backup-data-btn').addEventListener('click', () => this.backupData());
                document.getElementById('restore-data-btn').addEventListener('click', () => document.getElementById('restore-file-input').click());
                document.getElementById('restore-file-input').addEventListener('change', (e) => this.restoreData(e));
            }
            
            // --- DATA & SETTINGS ---
            loadAppSettings() {
                this.setTheme(localStorage.getItem('attendanceAppTheme') || 'light');
                this.schoolName = localStorage.getItem('attendanceAppSchoolName') || 'A Minha Escola';
                document.getElementById('page-subtitle').textContent = this.schoolName;
                this.setLanguage(localStorage.getItem('attendanceAppLang') || 'pt');
            }
            saveSchoolName() {
                const newName = document.getElementById('school-name-input').value.trim();
                if (newName) {
                    this.schoolName = newName;
                    localStorage.setItem('attendanceAppSchoolName', newName);
                    document.getElementById('page-subtitle').textContent = this.schoolName;
                    this.showToast(this.getTranslation('schoolNameUpdated'));
                }
            }
            async loadAppDataFromDB() {
                const data = await this.getConfig('appData');
                this.data = data || this.defaultData;
                if (!data) await this.saveAppDataToDB();
            }
            async saveAppDataToDB() {
                await this.setConfig('appData', this.data);
                this.renderCurrentView();
            }
            async loadAttendanceDataFromDB() {
                this.attendanceData = await this.getAllFromDB('attendance');
                this.updateDashboardStats();
            }

            // --- THEME, LANGUAGE & MODALS ---
            setTheme(theme) {
                document.documentElement.setAttribute('data-color-scheme', theme);
                localStorage.setItem('attendanceAppTheme', theme);
                document.getElementById('theme-light-btn').classList.toggle('active', theme === 'light');
                document.getElementById('theme-dark-btn').classList.toggle('active', theme === 'dark');
            }
            setLanguage(lang) {
                this.currentLanguage = lang;
                localStorage.setItem('attendanceAppLang', lang);
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.dataset.translate;
                    el.textContent = this.getTranslation(key);
                });
                document.documentElement.lang = lang.split('-')[0];
                
                document.getElementById('lang-pt-btn').classList.toggle('active', lang === 'pt');
                document.getElementById('lang-en-btn').classList.toggle('active', lang === 'en');
                document.getElementById('lang-es-btn').classList.toggle('active', lang === 'es');
                
                this.renderCurrentView(); // Re-render to update dynamic content
            }
            getTranslation(key) {
                return this.translations[this.currentLanguage]?.[key] || this.translations['pt'][key] || key;
            }
            openSettingsModal() {
                document.getElementById('school-name-input').value = this.schoolName;
                document.getElementById('settings-modal').classList.remove('hidden');
            }
            closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
            
            openClassEditor(classId = null) {
                this.currentClassId = classId || `class_${Date.now()}`;
                const isNew = !classId;
                const form = document.getElementById('class-editor-form');
                form.reset();
                document.getElementById('class-editor-title').textContent = isNew ? this.getTranslation('addNewClass') : this.getTranslation('editClass');
                document.getElementById('edit-class-id').value = this.currentClassId;
                
                if (!isNew) {
                    const turma = this.data.turmas.find(t => t.id === this.currentClassId);
                    document.getElementById('edit-class-name').value = turma.nome;
                    document.getElementById('edit-class-subject').value = turma.disciplina;
                    document.getElementById('edit-class-teacher').value = turma.professor;
                }
                this.renderClassEditorStudentList();
                document.getElementById('class-editor-modal').classList.remove('hidden');
            }
            closeClassEditor() { document.getElementById('class-editor-modal').classList.add('hidden'); this.currentClassId = null; }
            
            openStudentEditor(studentId = null) {
                const isNew = !studentId;
                const form = document.getElementById('student-editor-form');
                form.reset();
                document.getElementById('student-editor-title').textContent = isNew ? this.getTranslation('addStudent') : this.getTranslation('editStudent');
                document.getElementById('edit-student-id').value = isNew ? `student_${Date.now()}` : studentId;
                
                if (!isNew) {
                    const turma = this.data.turmas.find(t => t.id === this.currentClassId);
                    const aluno = turma.alunos.find(a => a.id == studentId);
                    document.getElementById('edit-student-name').value = aluno.nome;
                    document.getElementById('edit-student-number').value = aluno.numero;
                }
                document.getElementById('student-editor-modal').classList.remove('hidden');
            }
            closeStudentEditor() { document.getElementById('student-editor-modal').classList.add('hidden'); }

            openStudentImporter() {
                document.getElementById('import-student-list').value = '';
                document.getElementById('import-preview-container').classList.add('hidden');
                document.getElementById('student-importer-modal').classList.remove('hidden');
            }
            closeStudentImporter() { document.getElementById('student-importer-modal').classList.add('hidden'); }

            // --- CRUD OPERATIONS ---
            async saveClass(event) {
                event.preventDefault();
                const classId = document.getElementById('edit-class-id').value;
                const classIndex = this.data.turmas.findIndex(t => t.id === classId);
                const newClassData = {
                    id: classId,
                    nome: document.getElementById('edit-class-name').value,
                    disciplina: document.getElementById('edit-class-subject').value,
                    professor: document.getElementById('edit-class-teacher').value,
                    alunos: (classIndex > -1) ? this.data.turmas[classIndex].alunos : []
                };
                if (classIndex > -1) this.data.turmas[classIndex] = newClassData;
                else this.data.turmas.push(newClassData);
                await this.saveAppDataToDB();
                this.closeClassEditor();
                this.showToast(this.getTranslation('classSaved'));
            }
            async deleteClass(classId) {
                const confirmed = await this.showConfirm(this.getTranslation('deleteClass'), this.getTranslation('deleteClassConfirm'));
                if (confirmed) {
                    this.data.turmas = this.data.turmas.filter(t => t.id !== classId);
                    await this.saveAppDataToDB();
                    this.showToast(this.getTranslation('classDeleted'));
                }
            }
            async saveStudent(event) {
                event.preventDefault();
                const studentId = document.getElementById('edit-student-id').value;
                const turma = this.data.turmas.find(t => t.id === this.currentClassId);
                if (!turma) return;
                const newStudentData = {
                    id: studentId,
                    nome: document.getElementById('edit-student-name').value,
                    numero: parseInt(document.getElementById('edit-student-number').value)
                };
                const studentIndex = turma.alunos.findIndex(a => a.id == studentId);
                if (studentIndex > -1) turma.alunos[studentIndex] = newStudentData;
                else turma.alunos.push(newStudentData);
                await this.saveAppDataToDB();
                this.renderClassEditorStudentList();
                this.closeStudentEditor();
                this.showToast(this.getTranslation('studentSaved'));
            }
            async deleteStudent(studentId) {
                const turma = this.data.turmas.find(t => t.id === this.currentClassId);
                if (!turma) return;
                const confirmed = await this.showConfirm(this.getTranslation('deleteStudent'), this.getTranslation('deleteStudentConfirm'));
                if(confirmed) {
                    turma.alunos = turma.alunos.filter(a => a.id != studentId);
                    await this.saveAppDataToDB();
                    this.renderClassEditorStudentList();
                    this.showToast(this.getTranslation('studentDeleted'));
                }
            }

            previewStudentImport() {
                const text = document.getElementById('import-student-list').value;
                const previewContainer = document.getElementById('import-preview');
                const previewWrapper = document.getElementById('import-preview-container');
                previewContainer.innerHTML = '';

                const turma = this.data.turmas.find(t => t.id === this.currentClassId);
                const existingNumbers = new Set(turma.alunos.map(a => a.numero));

                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    previewWrapper.classList.add('hidden');
                    return;
                }

                let newStudentsCount = 0;
                lines.forEach(line => {
                    const parts = line.split(/[,;\t]/);
                    if (parts.length < 2) return;
                    
                    const numero = parseInt(parts[0].trim(), 10);
                    const nome = parts.slice(1).join(' ').trim();

                    if (!isNaN(numero) && nome) {
                        const item = document.createElement('div');
                        item.className = 'management-item';
                        let status;
                        if (existingNumbers.has(numero)) {
                            status = this.getTranslation('ignoreExistingNum');
                            item.style.opacity = '0.5';
                        } else {
                            status = `‚úîÔ∏è ${this.getTranslation('add')}`;
                            newStudentsCount++;
                        }
                        item.innerHTML = `<span><strong>${numero}.</strong> ${nome}</span> <span>${status}</span>`;
                        previewContainer.appendChild(item);
                    }
                });
                previewWrapper.classList.remove('hidden');
                document.querySelector('#import-students-confirm-btn span').textContent = `${this.getTranslation('import')} (${newStudentsCount})`;
            }

            async handleStudentImport() {
                const text = document.getElementById('import-student-list').value;
                const turma = this.data.turmas.find(t => t.id === this.currentClassId);
                if (!turma) return;

                const existingNumbers = new Set(turma.alunos.map(a => a.numero));
                const lines = text.split('\n').filter(line => line.trim() !== '');
                let importedCount = 0;

                lines.forEach(line => {
                    const parts = line.split(/[,;\t]/);
                    if (parts.length < 2) return;
                    
                    const numero = parseInt(parts[0].trim(), 10);
                    const nome = parts.slice(1).join(' ').trim();

                    if (!isNaN(numero) && nome && !existingNumbers.has(numero)) {
                        turma.alunos.push({ id: `student_${Date.now()}_${numero}`, numero, nome });
                        existingNumbers.add(numero);
                        importedCount++;
                    }
                });

                if (importedCount > 0) {
                    await this.saveAppDataToDB();
                    this.renderClassEditorStudentList();
                    this.showToast(`${importedCount} ${this.getTranslation('studentsImported')}`);
                } else {
                    this.showToast(this.getTranslation('noNewStudentsToImport'));
                }
                this.closeStudentImporter();
            }

            // --- UI & VIEWS ---
            renderCurrentView() {
                const activeView = document.querySelector('.view.active');
                if (!activeView) { this.showView('dashboard'); return; }
                switch(activeView.id) {
                    case 'dashboard-view': this.renderDashboard(); break;
                    case 'management-view': this.renderManagementView(); break;
                    case 'attendance-view': this.renderStudentsList(); break;
                    case 'reports-view': this.renderReportsView(); break;
                    case 'history-view': this.renderHistoryView(); break;
                    case 'individual-report-view': this.renderIndividualReportView(); break;
                }
            }

            showView(viewName) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                const view = document.getElementById(`${viewName}-view`);
                if (view) view.classList.add('active');
                
                document.getElementById('back-btn').classList.toggle('hidden', viewName === 'dashboard');
                
                let title = '';
                if (viewName === 'attendance') {
                    const currentClass = this.data.turmas.find(t => t.id === this.currentClassId);
                    title = currentClass ? currentClass.nome : '';
                } else {
                    const titleKey = { dashboard: 'appTitle', management: 'manageClasses', reports: 'reports', history: 'history', 'individual-report': 'studentReport' }[viewName] || 'appTitle';
                    title = this.getTranslation(titleKey);
                }
                document.getElementById('page-title').textContent = title;
                
                this.renderCurrentView();
            }
            
            renderDashboard() {
                this.updateDashboardStats();
                const grid = document.getElementById('classes-grid');
                grid.innerHTML = '';
                if (!this.data.turmas || this.data.turmas.length === 0) {
                    grid.innerHTML = `<p>${this.getTranslation('noClassesFound')}</p>`;
                    return;
                }
                this.data.turmas.forEach(turma => {
                    const card = document.createElement('div');
                    card.className = 'class-card';
                    card.dataset.classId = turma.id;
                    card.innerHTML = `<h3>${turma.nome}</h3><p>${turma.disciplina || this.getTranslation('noSubject')}</p>`;
                    grid.appendChild(card);
                });
            }
            
            updateDashboardStats() {
                const totalStudents = this.data.turmas.reduce((sum, turma) => sum + (turma.alunos ? turma.alunos.length : 0), 0);
                document.getElementById('total-students').textContent = totalStudents;

                const today = new Date().toISOString().split('T')[0];
                const todaysRecords = this.attendanceData.filter(record => record.date === today);
                
                const presentToday = new Set(todaysRecords.filter(r => r.status === 'presente').map(r => r.studentId)).size;
                const absentToday = new Set(todaysRecords.filter(r => r.status === 'ausente').map(r => r.studentId)).size;

                document.getElementById('present-today').textContent = presentToday;
                document.getElementById('absent-today').textContent = absentToday;
            }

            openClass(classId) { this.currentClassId = classId; this.showView('attendance'); }
            
            quickAttendance() {
                if (this.data.turmas && this.data.turmas.length > 0) {
                    this.openClass(this.data.turmas[0].id);
                } else {
                    this.showToast(this.getTranslation('noClassesAddOne'));
                }
            }

            renderManagementView() {
                const list = document.getElementById('management-list');
                list.innerHTML = '';
                this.data.turmas.forEach(turma => {
                    const item = document.createElement('div');
                    item.className = 'management-item';
                    item.innerHTML = `<span>${turma.nome} (${turma.alunos.length} ${this.getTranslation('students')})</span><div class="management-item-actions"><button class="btn btn--outline btn--sm edit-class-btn" data-class-id="${turma.id}">${this.getTranslation('edit')}</button><button class="btn btn--danger btn--sm delete-class-btn" data-class-id="${turma.id}">${this.getTranslation('delete')}</button></div>`;
                    list.appendChild(item);
                });
            }
            renderClassEditorStudentList() {
                const turma = this.data.turmas.find(t => t.id === this.currentClassId);
                const list = document.getElementById('class-editor-student-list');
                list.innerHTML = '';
                if (!turma || !turma.alunos) return;
                turma.alunos.sort((a,b) => a.numero - b.numero).forEach(aluno => {
                    const item = document.createElement('div');
                    item.className = 'management-item';
                    item.innerHTML = `<span><strong>${aluno.numero}.</strong> ${aluno.nome}</span><div class="management-item-actions"><button type="button" class="btn btn--outline btn--sm edit-student-btn" data-student-id="${aluno.id}">${this.getTranslation('edit')}</button><button type="button" class="btn btn--danger btn--sm delete-student-btn" data-student-id="${aluno.id}">${this.getTranslation('delete')}</button></div>`;
                    list.appendChild(item);
                });
            }

            // --- ATTENDANCE LOGIC ---
            renderStudentsList() {
                const container = document.getElementById('students-list');
                container.innerHTML = '';
                const currentClass = this.data.turmas.find(t => t.id === this.currentClassId);
                if (!currentClass) return;

                document.getElementById('attendance-class-name').textContent = currentClass.nome;
                
                const today = new Date().toISOString().split('T')[0];
                const todaysRecords = this.attendanceData.filter(r => r.date === today && r.classId === this.currentClassId);

                currentClass.alunos.sort((a,b) => a.numero - b.numero).forEach(aluno => {
                    const key = this.getAttendanceKey(aluno.id);
                    const attendance = todaysRecords.find(r => r.id === key);
                    const statusInfo = this.getStatusInfo(attendance?.status);

                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.dataset.studentId = aluno.id;
                    if (attendance) item.classList.add(attendance.status);
                    
                    item.innerHTML = `
                        <div class="student-info">
                            <div class="student-number">${aluno.numero}</div>
                            <div class="student-name">${aluno.nome}</div>
                        </div>
                        <div class="student-status">
                            <span class="status-icon">${statusInfo.icon}</span>
                            <span>${statusInfo.text}</span>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
            openStudentModal(studentId) {
                this.currentStudentId = studentId;
                const currentClass = this.data.turmas.find(t => t.id === this.currentClassId);
                const student = currentClass.alunos.find(a => a.id === studentId);
                document.getElementById('modal-student-name').textContent = student.nome;
                
                const key = this.getAttendanceKey(student.id);
                const attendance = this.attendanceData.find(r => r.id === key);
                
                document.getElementById('student-note').value = attendance?.note || '';
                this.selectAttendanceStatus(attendance?.status);
                document.getElementById('student-modal').classList.remove('hidden');
            }
            closeStudentModal() { document.getElementById('student-modal').classList.add('hidden'); }
            selectAttendanceStatus(status) {
                document.querySelectorAll('#modal-attendance-options .attendance-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.status === status);
                });
            }
            async saveStudentAttendance() {
                const selectedBtn = document.querySelector('#modal-attendance-options .attendance-btn.selected');
                if (!selectedBtn) { this.showToast(this.getTranslation('selectStatusError')); return; }
                
                const status = selectedBtn.dataset.status;
                const note = document.getElementById('student-note').value.trim();
                
                await this.markStudentAttendance(this.currentStudentId, status, note);
                this.closeStudentModal();
            }
            
            async markStudentAttendance(studentId, status, note = '', shouldRender = true) {
                const key = this.getAttendanceKey(studentId);
                const record = { id: key, date: new Date().toISOString().split('T')[0], classId: this.currentClassId, studentId, status, note };

                const recordIndex = this.attendanceData.findIndex(r => r.id === key);
                if (recordIndex > -1) this.attendanceData[recordIndex] = record;
                else this.attendanceData.push(record);

                await this.putInDB('attendance', record);
                
                if (shouldRender) {
                    this.renderStudentsList();
                    this.updateDashboardStats();
                }
            }

            async markAllPresent() {
                const currentClass = this.data.turmas.find(t => t.id === this.currentClassId);
                if (!currentClass) return;
                const promises = currentClass.alunos.map(student => {
                    const key = this.getAttendanceKey(student.id);
                    if (!this.attendanceData.some(r => r.id === key)) {
                        return this.markStudentAttendance(student.id, 'presente', '', false); // Don't re-render for each
                    }
                    return Promise.resolve();
                });

                await Promise.all(promises);
                this.renderStudentsList();
                this.showToast(this.getTranslation('allMarkedPresent'));
                this.updateDashboardStats();
            }
            getAttendanceKey(studentId) {
                const today = new Date().toISOString().split('T')[0];
                return `${today}-${this.currentClassId}-${studentId}`;
            }
            getStatusInfo(status) {
                switch (status) {
                    case 'presente': return { icon: '&#10003;', text: this.getTranslation('present') };
                    case 'ausente': return { icon: '&#10007;', text: this.getTranslation('absent') };
                    case 'atrasado': return { icon: '&#9200;', text: this.getTranslation('late') };
                    case 'justificado': return { icon: '&#128196;', text: this.getTranslation('justified') };
                    default: return { icon: '&#9675;', text: this.getTranslation('unmarked') };
                }
            }

            // --- REPORTS & HISTORY ---
            showReports() { this.showView('reports'); }
            showHistory() { this.showView('history'); }
            showIndividualReport() { this.showView('individual-report'); }

            renderReportsView() {
                document.getElementById('week-picker').value = this.getISOWeekAndYear(new Date());
                this.updateWeeklyReport(document.getElementById('week-picker').value);
            }
            
            updateWeeklyReport(weekString) {
                if (!weekString) return;
                const [year, week] = weekString.split('-W').map(Number);
                const startDate = this.getDateOfISOWeek(week, year);

                this.createWeeklyChart(startDate);
                this.createWeeklySummary(startDate);
            }

            createWeeklyChart(startDate) {
                const labels = [];
                const weekData = { presente: [], ausente: [] };
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(date.toLocaleDateString(this.currentLanguage, { weekday: 'short' }));
                    weekData.presente.push(this.attendanceData.filter(att => att.date === dateStr && att.status === 'presente').length);
                    weekData.ausente.push(this.attendanceData.filter(att => att.date === dateStr && att.status === 'ausente').length);
                }
                this.createChart('weekly-chart', 'bar', {
                    labels,
                    datasets: [
                        { label: this.getTranslation('presents'), data: weekData.presente, backgroundColor: 'rgba(76, 175, 80, 0.7)' },
                        { label: this.getTranslation('absences'), data: weekData.ausente, backgroundColor: 'rgba(244, 67, 54, 0.7)' }
                    ]
                }, { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: 'var(--color-text-secondary)' } }, x: { ticks: { color: 'var(--color-text-secondary)' } } } });
            }

            createWeeklySummary(startDate) {
                let totalPresent = 0, totalAbsent = 0, totalLate = 0;
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    this.attendanceData.forEach(att => {
                        if (att.date === dateStr) {
                            if (att.status === 'presente') totalPresent++;
                            else if (att.status === 'ausente') totalAbsent++;
                            else if (att.status === 'atrasado') totalLate++;
                        }
                    });
                }
                const totalAttendable = totalPresent + totalAbsent + totalLate;
                const attendanceRate = totalAttendable > 0 ? Math.round((totalPresent / totalAttendable) * 100) : 0;
                document.getElementById('weekly-summary').innerHTML = `
                    <div class="summary-item"><div class="summary-number">${totalPresent}</div><div class="summary-label">${this.getTranslation('presents')}</div></div>
                    <div class="summary-item"><div class="summary-number">${totalAbsent}</div><div class="summary-label">${this.getTranslation('absences')}</div></div>
                    <div class="summary-item"><div class="summary-number">${totalLate}</div><div class="summary-label">${this.getTranslation('lates')}</div></div>
                    <div class="summary-item"><div class="summary-number">${attendanceRate}%</div><div class="summary-label">${this.getTranslation('attendanceRate')}</div></div>
                `;
            }

            renderHistoryView() {
                const classFilter = document.getElementById('class-filter');
                const currentVal = classFilter.value;
                classFilter.innerHTML = `<option value="">${this.getTranslation('allClasses')}</option>`;
                this.data.turmas.forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma.id;
                    option.textContent = turma.nome;
                    classFilter.appendChild(option);
                });
                classFilter.value = currentVal;
                if(!document.getElementById('date-filter').value) {
                    document.getElementById('date-filter').valueAsDate = new Date();
                }
                this.filterHistory();
            }

            filterHistory() {
                const classFilterValue = document.getElementById('class-filter').value;
                const dateFilterValue = document.getElementById('date-filter').value;
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                const filteredRecords = this.attendanceData.filter(record => {
                    const classMatch = !classFilterValue || record.classId === classFilterValue;
                    const dateMatch = !dateFilterValue || record.date === dateFilterValue;
                    return classMatch && dateMatch;
                });

                const groupedRecords = filteredRecords.reduce((acc, record) => {
                    const key = `${record.date}-${record.classId}`;
                    if (!acc[key]) {
                        const className = this.data.turmas.find(t => t.id === record.classId)?.nome || 'Turma Desconhecida';
                        acc[key] = { date: record.date, className, records: [] };
                    }
                    acc[key].records.push(record);
                    return acc;
                }, {});

                const sortedGroups = Object.values(groupedRecords).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (sortedGroups.length === 0) {
                    historyList.innerHTML = `<p style="text-align: center; padding: 2rem;">${this.getTranslation('noRecordsFound')}</p>`;
                    return;
                }

                sortedGroups.forEach(group => {
                    const present = group.records.filter(r => r.status === 'presente').length;
                    const absent = group.records.filter(r => r.status === 'ausente').length;
                    
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-header-info">
                            <h4>${group.className}</h4>
                            <span class="history-date">${new Date(group.date + 'T00:00:00').toLocaleDateString(this.currentLanguage)}</span>
                        </div>
                        <div class="history-stats">
                            <div class="history-stat"><span style="color: #4CAF50;">&#10003;</span> ${present} ${this.getTranslation('presents')}</div>
                            <div class="history-stat"><span style="color: #F44336;">&#10007;</span> ${absent} ${this.getTranslation('absences')}</div>
                        </div>
                    `;
                    historyList.appendChild(item);
                });
            }

            renderIndividualReportView() {
                const classFilter = document.getElementById('individual-report-class-filter');
                classFilter.innerHTML = `<option value="">${this.getTranslation('selectClass')}</option>`;
                this.data.turmas.forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma.id;
                    option.textContent = turma.nome;
                    classFilter.appendChild(option);
                });

                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 30);
                document.getElementById('individual-report-start-date').valueAsDate = startDate;
                document.getElementById('individual-report-end-date').valueAsDate = endDate;

                this.populateIndividualStudentFilter('');
                this.generateIndividualReport();
            }

            populateIndividualStudentFilter(classId) {
                const studentFilter = document.getElementById('individual-report-student-filter');
                studentFilter.innerHTML = `<option value="">${this.getTranslation('selectStudent')}</option>`;
                studentFilter.disabled = true;
                if (!classId) return;

                const turma = this.data.turmas.find(t => t.id === classId);
                if (turma && turma.alunos) {
                    turma.alunos.sort((a, b) => a.numero - b.numero).forEach(aluno => {
                        const option = document.createElement('option');
                        option.value = aluno.id;
                        option.textContent = `${aluno.numero}. ${aluno.nome}`;
                        studentFilter.appendChild(option);
                    });
                    studentFilter.disabled = false;
                }
                this.generateIndividualReport();
            }

            generateIndividualReport() {
                const classId = document.getElementById('individual-report-class-filter').value;
                const studentId = document.getElementById('individual-report-student-filter').value;
                const startDate = document.getElementById('individual-report-start-date').value;
                const endDate = document.getElementById('individual-report-end-date').value;
                const contentEl = document.getElementById('individual-report-content');

                if (!classId || !studentId || !startDate || !endDate) {
                    contentEl.classList.add('hidden');
                    return;
                }
                
                const student = this.data.turmas.find(t => t.id === classId)?.alunos.find(a => a.id === studentId);
                document.getElementById('individual-report-student-name').textContent = `${this.getTranslation('reportFor')} ${student.nome}`;

                const records = this.attendanceData.filter(r => {
                    return r.studentId === studentId && r.date >= startDate && r.date <= endDate;
                });

                let present = 0, absent = 0, late = 0, justified = 0;
                records.forEach(r => {
                    if (r.status === 'presente') present++;
                    else if (r.status === 'ausente') absent++;
                    else if (r.status === 'atrasado') late++;
                    else if (r.status === 'justificado') justified++;
                });
                
                const total = present + absent + late + justified;
                const attendanceRate = total > 0 ? Math.round((present / total) * 100) : 0;
                
                document.getElementById('individual-report-summary').innerHTML = `
                    <div class="summary-item"><div class="summary-number">${present}</div><div class="summary-label">${this.getTranslation('presents')}</div></div>
                    <div class="summary-item"><div class="summary-number">${absent}</div><div class="summary-label">${this.getTranslation('absences')}</div></div>
                    <div class="summary-item"><div class="summary-number">${late}</div><div class="summary-label">${this.getTranslation('lates')}</div></div>
                    <div class="summary-item"><div class="summary-number">${attendanceRate}%</div><div class="summary-label">${this.getTranslation('attendanceRate')}</div></div>
                `;

                const listEl = document.getElementById('individual-report-list');
                listEl.innerHTML = '';
                if (records.length === 0) {
                    listEl.innerHTML = `<p style="text-align: center; padding: 2rem;">${this.getTranslation('noRecordsInPeriod')}</p>`;
                } else {
                    records.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.innerHTML = `
                            <div class="history-header-info">
                                <h4>${new Date(record.date + 'T00:00:00').toLocaleDateString(this.currentLanguage)}</h4>
                                <span class="history-date">${this.getTranslation(record.status)}</span>
                            </div>
                            ${record.note ? `<p style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">${record.note}</p>` : ''}
                        `;
                        listEl.appendChild(item);
                    });
                }

                contentEl.classList.remove('hidden');
            }

            createChart(canvasId, type, data, options) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;
                if (this.charts[canvasId]) this.charts[canvasId].destroy();
                this.charts[canvasId] = new Chart(ctx.getContext('2d'), { type, data, options });
            }

            // --- EXPORT ---
            exportHistoryToCSV() {
                const classFilterValue = document.getElementById('class-filter').value;
                const dateFilterValue = document.getElementById('date-filter').value;
                const records = this.attendanceData.filter(record => {
                    const classMatch = !classFilterValue || record.classId === classFilterValue;
                    const dateMatch = !dateFilterValue || record.date === dateFilterValue;
                    return classMatch && dateMatch;
                });
                this.exportToCSV(records, `historico_${dateFilterValue || 'completo'}.csv`);
            }

            exportWeekReportToCSV() {
                const weekString = document.getElementById('week-picker').value;
                if (!weekString) return;
                const [year, week] = weekString.split('-W').map(Number);
                const startOfWeek = this.getDateOfISOWeek(week, year);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);

                const records = this.attendanceData.filter(record => {
                    const recordDate = new Date(record.date + 'T00:00:00');
                    return recordDate >= startOfWeek && recordDate <= endOfWeek;
                });
                this.exportToCSV(records, `relatorio_semana_${week}.csv`);
            }

            exportIndividualReportToCSV() {
                const classId = document.getElementById('individual-report-class-filter').value;
                const studentId = document.getElementById('individual-report-student-filter').value;
                const startDate = document.getElementById('individual-report-start-date').value;
                const endDate = document.getElementById('individual-report-end-date').value;

                if (!studentId) {
                    this.showToast(this.getTranslation('selectStudentToExport'));
                    return;
                }

                const student = this.data.turmas.find(t => t.id === classId)?.alunos.find(a => a.id === studentId);
                const records = this.attendanceData.filter(r => {
                    return r.studentId === studentId && r.date >= startDate && r.date <= endDate;
                });

                this.exportToCSV(records, `relatorio_${student.nome.replace(/\s/g, '_')}.csv`);
            }

            exportToCSV(records, filename) {
                if (records.length === 0) {
                    this.showToast(this.getTranslation('noDataToExport'));
                    return;
                }
                const headers = ["Data", "Turma", "Numero", "Aluno", "Estado", "Observacoes"];
                const rows = records.map(record => {
                    const turma = this.data.turmas.find(t => t.id === record.classId);
                    const aluno = turma?.alunos.find(a => a.id === record.studentId);
                    const safeNote = `"${(record.note || '').replace(/"/g, '""')}"`;
                    return [record.date, turma?.nome || 'N/A', aluno?.numero || 'N/A', aluno?.nome || 'N/A', record.status, safeNote].join(',');
                });

                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showToast(this.getTranslation('exportComplete'));
            }

            // --- BACKUP & RESTORE ---
            async backupData() {
                try {
                    const backupData = {
                        settings: {
                            schoolName: this.schoolName,
                            theme: localStorage.getItem('attendanceAppTheme') || 'light',
                            lang: this.currentLanguage || 'pt'
                        },
                        appData: this.data,
                        attendanceData: this.attendanceData
                    };

                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], {type: "application/json"});
                    const url = URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    const today = new Date().toISOString().split('T')[0];
                    link.download = `backup_presencas_${today}.json`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    this.showToast(this.getTranslation('backupCreated'));
                } catch (error) {
                    console.error("Erro ao criar backup:", error);
                    this.showToast(this.getTranslation('backupError'));
                }
            }

            restoreData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.appData || !data.attendanceData || !data.settings) {
                            throw new Error("Ficheiro de backup inv√°lido.");
                        }

                        const confirmed = await this.showConfirm(
                            this.getTranslation('restoreData'), 
                            this.getTranslation('restoreDataConfirm')
                        );

                        if (confirmed) {
                            await this.performRestore(data);
                        }
                    } catch (error) {
                        console.error("Erro ao restaurar dados:", error);
                        this.showToast(this.getTranslation('restoreErrorInvalidFile'));
                    } finally {
                        event.target.value = null; // Reset file input
                    }
                };
                reader.readAsText(file);
            }

            async performRestore(data) {
                try {
                    // Clear existing data
                    await this.clearDBStore('config');
                    await this.clearDBStore('attendance');

                    // Restore settings
                    this.schoolName = data.settings.schoolName;
                    this.setTheme(data.settings.theme);
                    this.setLanguage(data.settings.lang);
                    localStorage.setItem('attendanceAppSchoolName', this.schoolName);
                    
                    // Restore app data (classes, students)
                    this.data = data.appData;
                    await this.setConfig('appData', this.data);

                    // Restore attendance data
                    this.attendanceData = data.attendanceData;
                    const tx = this.db.transaction('attendance', 'readwrite');
                    const store = tx.objectStore('attendance');
                    this.attendanceData.forEach(record => store.put(record));

                    await new Promise((resolve, reject) => {
                        tx.oncomplete = resolve;
                        tx.onerror = () => reject(tx.error);
                    });

                    this.showToast(this.getTranslation('restoreSuccess'));
                    setTimeout(() => window.location.reload(), 2000);

                } catch (error) {
                    console.error("Falha ao executar o restauro:", error);
                    this.showToast(this.getTranslation('restoreFatalError'));
                }
            }


            // --- UTILITIES ---
            showToast(message) {
                const toast = document.getElementById('toast');
                toast.querySelector('#toast-message').textContent = message;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            }
            showConfirm(title, message) {
                return new Promise(resolve => {
                    const modal = document.getElementById('confirm-modal');
                    modal.querySelector('#confirm-title').textContent = title;
                    modal.querySelector('#confirm-message').textContent = message;
                    modal.classList.remove('hidden');
                    const okBtn = modal.querySelector('#confirm-ok-btn');
                    const cancelBtn = modal.querySelector('#confirm-cancel-btn');
                    const cleanup = () => { modal.classList.add('hidden'); okBtn.replaceWith(okBtn.cloneNode(true)); cancelBtn.replaceWith(cancelBtn.cloneNode(true)); };
                    okBtn.addEventListener('click', () => { cleanup(); resolve(true); }, { once: true });
                    cancelBtn.addEventListener('click', () => { cleanup(); resolve(false); }, { once: true });
                });
            }
            getISOWeekAndYear(date) {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
            }
            getDateOfISOWeek(w, y) {
                const simple = new Date(y, 0, 1 + (w - 1) * 7);
                const dow = simple.getDay();
                const ISOweekStart = simple;
                if (dow <= 4)
                    ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
                else
                    ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
                return ISOweekStart;
            }
            
            // --- DB HELPERS ---
            async setConfig(key, value) { return this.putInDB('config', { key, value }); }
            async getConfig(key) { const result = await this.getFromDB('config', key); return result?.value; }
            async putInDB(storeName, data) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    store.put(data);
                    tx.oncomplete = resolve;
                    tx.onerror = () => reject(tx.error);
                });
            }
            async getFromDB(storeName, key) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const request = tx.objectStore(storeName).get(key);
                    tx.oncomplete = () => resolve(request.result);
                    tx.onerror = () => reject(tx.error);
                });
            }
            async getAllFromDB(storeName) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const request = tx.objectStore(storeName).getAll();
                    tx.oncomplete = () => resolve(request.result);
                    tx.onerror = () => reject(tx.error);
                });
            }
            async clearDBStore(storeName) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    store.clear();
                    tx.oncomplete = resolve;
                    tx.onerror = () => reject(tx.error);
                });
            }

            // --- SWIPE GESTURES ---
            handleTouchStart(e) {
                const touch = e.touches[0];
                this.touchStartX = touch.clientX;
                this.touchStartY = touch.clientY;
                this.swipedItem = e.target.closest('.student-item');
                this.isSwiping = false;
            }

            handleTouchMove(e) {
                if (!this.swipedItem) return;
                const touch = e.touches[0];
                this.touchEndX = touch.clientX;
                this.touchEndY = touch.clientY;
                
                const diffX = this.touchEndX - this.touchStartX;
                const diffY = this.touchEndY - this.touchStartY;

                // Only start swiping if horizontal movement is greater than vertical
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    this.isSwiping = true;
                    this.swipedItem.classList.add('swiping');
                    // Only allow right swipe
                    const translateX = Math.max(0, diffX);
                    this.swipedItem.style.transform = `translateX(${translateX}px)`;
                }
            }

            async handleTouchEnd(e) {
                if (!this.swipedItem || !this.isSwiping) return;

                const diffX = this.touchEndX - this.touchStartX;
                const threshold = this.swipedItem.offsetWidth * 0.4; // 40% of item width

                if (diffX > threshold) {
                    // Swipe right successful
                    await this.markStudentAttendance(this.swipedItem.dataset.studentId, 'presente');
                    this.swipedItem.style.transform = 'translateX(0)'; // Reset style
                } else {
                    // Swipe not far enough, animate back
                    this.swipedItem.style.transform = 'translateX(0)';
                }
                
                this.swipedItem.classList.remove('swiping');
                this.swipedItem = null;
                // A small delay to prevent click event after swipe
                setTimeout(() => { this.isSwiping = false; }, 100);
            }
        }

        document.addEventListener('DOMContentLoaded', () => { window.app = new AttendanceApp(); });
    </script>
</body>
</html>
